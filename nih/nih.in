#!/bin/sh

set -e 

export LC_ALL=C

usage (){
    cat 1>&2 <<'EOF'
blablabla help, see README
EOF
}

sysconfdir=${NIH_SYSCONFDIR-@sysconfdir@}/nih
libexecdir=${NIH_LIBEXECDIR-@libexecdir@}
confdir=$HOME/.nih

# loading config files
if test -r "$sysconfdir/config"; then
    conffile="$sysconfdir/config"
elif test -r "$confdir/config"; then
    conffile="$confdir/config"
else
    cat <<EOF
Neither $sysconfdir/config not $confdir/config are readable.
Sorry, I cannot help.
EOF
    exit 1
fi

. "$conffile"

# handling global options
if test "_$1" = _-h; then
    usage
    exit 0
elif test "_$1" = _-V; then
    echo pkgnih @VERSION@
    exit 0
fi

if test $# -eq 0; then
    usage
    exit 1
fi

# handling commands

######################################################################
# help
if test "$1" = help; then
    usage
    exit 0
fi

######################################################################
# refresh
if test "$1" = refresh; then
    exit 0
fi

######################################################################
# install | upgrade
if test "_$1" = _install -o "_$1" = _upgrade; then
    exit 0
fi

######################################################################
# uninstall | remove | delete
if test "_$1" = _uninstall -o "_$1" = _remove -o "_$1" = _delete; then
    exit 0
fi

######################################################################
# verify
if test "$1" = verify; then
    exit 0
fi

######################################################################
# status
usage_status (){
    cat <<'EOF'
nih status [options] [PKGBASEs]
     Compare installed packages with pkg_summary.txt (default) or
     pkgsrc tree.
   options:
       -h     display this help message
       -b     compare installed packages against pkg_summary.txt (default)
       -s     compare installed packages against pkgsrc tree
       -r     raw output (pkg_summary format)
       -u     analyse packages marked as installed by user (the default, see -a)
       -a     analyse all packages (see -u)
       -Q     No noisy reminder about output format
EOF
}

if test "$1" = status; then
    shift
    opts='b'
    while getopts hbsruaQ f; do
	case "$f" in
	    '?')
		echo "Unknown suboption $f for command 'status'"
		exit 1;;
	    h)
		usage_status
		exit 0;;
	    *)
		opts="${opts}$f";;
	esac
    done
    shift `expr $OPTIND - 1`

    export PKG_SUMMARY
    pkg_status "-$opts" "$@"

    exit 0
fi

######################################################################
# audit
if test "$1" = audit; then
    exit 0
fi

######################################################################
# search
if test "$1" = search; then
    exit 0
fi

######################################################################
# leaf
if test "$1" = leaf; then
    exit 0
fi

######################################################################
# list
if test "$1" = list; then
    exit 0
fi

######################################################################
# license
if test "$1" = license; then
    exit 0
fi

######################################################################
# <bad> command
echo "Unknown command '$1', see nih -h for more information" 1>&2
exit 2
